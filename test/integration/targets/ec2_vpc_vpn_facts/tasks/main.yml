---
- block:

  # ============================================================
  - name: set up aws connection info
    set_fact:
      aws_connection_info: &aws_connection_info
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        security_token: "{{ security_token }}"
        region: "{{ aws_region }}"
    no_log: yes

  # ============================================================
  - name: create customer gateway
    ec2_customer_gateway:
      bgp_asn: 12345
      ip_address: 1.2.3.4
      name: testcgw
      region: '{{ ec2_region }}'
      <<: *aws_connection_info
    register: cgw

  - name: create vpn connection, without customer gateway created in above task
    ec2_vpc_vpn:
      state: present
      <<: *aws_connection_info
    register: vpn

  - name: create vpn connection, with customer gateway
    ec2_vpc_vpn:
      customer_gateway_id: '{{ cgw.gateway.customer_gateways.customer_gateway_id }}'
      state: present
      <<: *aws_connection_info
    register: vpn2

  # ============================================================
  - name: test success with no parameters
    ec2_vpc_vpn_facts:
      <<: *aws_connection_info
    register: result

  - name: assert success with no parameters
    assert:
      that:
        - 'result.changed == false'
        - 'result.vpn_connections != []'

  - name: test success with customer gateway id as a filter
    ec2_vpc_vpn_facts:
      filters:
        customer-gateway-id: '{{ cgw.gateway.customer_gateways.customer_gateway_id }}'
        vpn-connection-id: '{{ vpn2.vpn_connection_id }}'
      <<: *aws_connection_info
    register: result

  - name: assert success with customer gateway id as filter
    assert:
      that:
        - 'result.changed == false'
        - 'result.vpn_connections != []'

  # ============================================================
  - name: delete vpn connection
    ec2_vpc_vpn:
      state: absent
      vpn_connection_id: '{{ vpn2.vpn_connection_id }}'
      <<: *aws_connection_info

  - name: delete vpn connection
    ec2_vpc_vpn:
      state: absent
      vpn_connection_id: '{{ vpn.vpn_connection_id }}'
      <<: *aws_connection_info

  - name: delete customer gateway
    ec2_customer_gateway:
      state: absent
      customer_gateway_id: '{{ cgw.gateway.customer_gateways.customer_gateway_id }}'
      <<: *aws_connection_info
