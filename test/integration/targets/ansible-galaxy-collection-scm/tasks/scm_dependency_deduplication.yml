- name: Install all collections in a repo, one of which has a recursive dependency
  command: 'ansible-galaxy collection install git+file://{{ galaxy_dir }}/development/namespace_1/.git'
  register: command

- assert:
    that:
      - command.stdout_lines | length == 12
      - command.stdout_lines[5] == "Starting collection install process"
      - "'namespace_1.collection_1' in command.stdout_lines[6]"
      - "'namespace_1.collection_1' in command.stdout_lines[7]"
      - "'namespace_1.collection_1' in command.stdout_lines[8]"
      - "'namespace_2.collection_2' in command.stdout_lines[9]"
      - "'namespace_2.collection_2' in command.stdout_lines[10]"
      - "'namespace_2.collection_2' in command.stdout_lines[11]"

- name: list installed collections
  command: 'ansible-galaxy collection list'
  register: installed_collections

- assert:
    that:
      - "'namespace_1.collection_1' in installed_collections.stdout"
      - "'namespace_2.collection_2' in installed_collections.stdout"

- name: Install a specific collection in a repo with a recursive dependency
  command: 'ansible-galaxy collection install git+file://{{ galaxy_dir }}/development/namespace_1/.git#/collection_1/ --force-with-deps'
  register: command

- assert:
    that:
      - command.stdout_lines | length == 12
      - command.stdout_lines[5] == "Starting collection install process"
      - "'namespace_1.collection_1' in command.stdout_lines[6]"
      - "'namespace_1.collection_1' in command.stdout_lines[7]"
      - "'namespace_1.collection_1' in command.stdout_lines[8]"
      - "'namespace_2.collection_2' in command.stdout_lines[9]"
      - "'namespace_2.collection_2' in command.stdout_lines[10]"
      - "'namespace_2.collection_2' in command.stdout_lines[11]"

- name: list installed collections
  command: 'ansible-galaxy collection list'
  register: installed_collections

- assert:
    that:
      - "'namespace_1.collection_1' in installed_collections.stdout"
      - "'namespace_2.collection_2' in installed_collections.stdout"

- include_tasks: ./empty_installed_collections.yml
  when: cleanup
